{% extends "base.html" %}

{% block title %}Today - Casey{% endblock %}

{% block extra_styles %}
.date-label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 0.25rem;
    letter-spacing: 0.01em;
}

.greeting {
    font-size: 1.375rem;
    font-weight: 600;
    letter-spacing: -0.025em;
    color: var(--text);
    margin-bottom: 1.5rem;
}

.journal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.journal-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.word-count {
    font-size: 12px;
    color: var(--text-muted);
}

.journal-card {
    margin-bottom: 2rem;
}

.journal-card textarea {
    min-height: 280px;
}

.mood-selector {
    display: flex;
    gap: 0.25rem;
    align-items: center;
}

.mood-option {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 14px;
    border: 1px solid var(--border);
    background: var(--surface);
    transition: all 0.15s;
}

.mood-option:hover { border-color: var(--accent); }
.mood-option input { display: none; }
.mood-option.selected { border-color: var(--accent); background: var(--accent-subtle); }

.template-select {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
}

.template-btn {
    font-size: 11px;
    padding: 0.25rem 0.5rem;
    min-height: auto;
    background: var(--surface);
    color: var(--text-muted);
    border: 1px solid var(--border);
    cursor: pointer;
    border-radius: var(--radius-xs);
    font-family: var(--font);
    font-weight: 500;
    transition: all 0.15s;
}

.template-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-subtle);
}

/* Secondary sections */
.secondary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
}

.section-quiet {
    padding-top: 0.5rem;
}

.section-quiet h3 {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
}

.task-add-row {
    display: flex;
    gap: 0.375rem;
    margin-bottom: 0.75rem;
}

.task-add-row input[type="text"] {
    flex: 1;
    font-size: 13px;
    padding: 0.375rem 0.625rem;
    border-color: var(--border-light);
}

.task-add-row button {
    flex-shrink: 0;
    font-size: 12px;
    padding: 0.375rem 0.625rem;
    min-height: auto;
    background: var(--border-light);
    color: var(--text-secondary);
}

.task-add-row button:hover { background: var(--border); color: var(--text); }

.quiet-task-list {
    list-style: none;
}

.quiet-task-list li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3125rem 0;
    font-size: 13px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-light);
}

.quiet-task-list li:last-child { border-bottom: none; }

.quiet-task-list li.completed span {
    text-decoration: line-through;
    color: var(--text-muted);
}

.quiet-task-list input[type="checkbox"] {
    width: 15px;
    height: 15px;
    min-width: 15px;
    border: 1.5px solid var(--border);
    border-radius: 3px;
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    position: relative;
    background: var(--surface);
    flex-shrink: 0;
}

.quiet-task-list input[type="checkbox"]:checked {
    background: var(--text-muted);
    border-color: var(--text-muted);
}

.quiet-task-list input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    left: 4px;
    top: 1px;
    width: 4px;
    height: 8px;
    border: solid white;
    border-width: 0 1.5px 1.5px 0;
    transform: rotate(45deg);
}

.quiet-task-list .due-hint {
    font-size: 11px;
    color: var(--text-muted);
    margin-left: auto;
    white-space: nowrap;
    flex-shrink: 0;
}

.quiet-task-list .due-hint.overdue { color: var(--danger); }
.quiet-task-list .due-hint.due-today { color: #E65100; }
[data-theme="dark"] .quiet-task-list .due-hint.due-today { color: #FFB74D; }

.quiet-task-list .task-link {
    color: inherit;
    text-decoration: none;
}

.quiet-task-list .task-link:hover { color: var(--text); }

.tasks-footer {
    margin-top: 0.5rem;
    font-size: 11px;
}

.tasks-footer a {
    color: var(--text-muted);
    text-decoration: none;
    font-weight: 500;
}

.tasks-footer a:hover { color: var(--text-secondary); }

.quiet-blip {
    font-size: 13px;
    line-height: 1.6;
    color: var(--text-secondary);
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-light);
}

.quiet-blip:last-child { border-bottom: none; }

.quiet-blip-meta {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 0.125rem;
}

.quiet-empty {
    font-size: 12px;
    color: var(--text-muted);
    padding: 0.5rem 0;
}

.quiet-empty a {
    color: var(--accent);
    text-decoration: none;
}

.recurrence-badge {
    font-size: 10px;
    padding: 0.0625rem 0.3125rem;
    border-radius: 3px;
    background: var(--border-light);
    color: var(--text-muted);
    white-space: nowrap;
    margin-left: 0.125rem;
}

.welcome {
    padding: 2.5rem 2rem;
    text-align: center;
    margin-bottom: 1.5rem;
}

.welcome h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    letter-spacing: -0.025em;
}

.welcome p {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.7;
    max-width: 480px;
    margin: 0 auto;
}

@media (max-width: 600px) {
    .secondary-grid { grid-template-columns: 1fr; gap: 1.5rem; }
    .journal-card textarea { min-height: 200px; }
}
{% endblock %}

{% block content %}
<div class="date-label">{{ today | uk_date_long }}</div>

{% if is_new_user %}
<div class="card welcome">
    <h2>Welcome to Casey</h2>
    <p>A calm space for writing, thinking, and staying on track. Start with today's journal entry.</p>
</div>
{% else %}
<div class="greeting">
    {% set hour = now.hour if now is defined else 12 %}
    {% if hour < 12 %}Good morning{% elif hour < 17 %}Good afternoon{% else %}Good evening{% endif %}{% if stats.streak > 1 %}<span style="font-weight: 400; font-size: 0.875rem; color: var(--text-muted); margin-left: 0.75rem;">{{ stats.streak }} day streak</span>{% endif %}
</div>
{% endif %}

<div class="card journal-card">
    <div class="journal-header">
        <h2 style="margin-bottom: 0;">Journal</h2>
        <div class="journal-meta">
            <span id="word-count" class="word-count">{{ (journal.content if journal else '') | word_count }} words</span>
            <span id="save-indicator" class="save-indicator">Saved</span>
        </div>
    </div>
    <form id="journal-form" method="POST" action="/journal/save">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {% if not journal or not journal.content %}
        <div class="template-select">
            {% for tmpl in templates %}
            {% if tmpl.content %}
            <button type="button" class="template-btn" onclick="applyTemplate('{{ tmpl.content | e }}')">{{ tmpl.name }}</button>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
        <textarea id="journal-content" name="content" placeholder="What's on your mind today?">{{ journal.content if journal else '' }}</textarea>
        <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.75rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 12px; color: var(--text-muted); font-weight: 500;">Mood</span>
                <div class="mood-selector">
                    {% for val, label in [(1, 'üòî'), (2, 'üòê'), (3, 'üôÇ'), (4, 'üòä'), (5, 'ü§©')] %}
                    <label class="mood-option {{ 'selected' if journal and journal.mood == val }}" title="{{ ['Rough','Meh','Okay','Good','Great'][val-1] }}" onclick="this.parentElement.querySelectorAll('.mood-option').forEach(e=>e.classList.remove('selected'));this.classList.add('selected')">
                        <input type="radio" name="mood" value="{{ val }}" {{ 'checked' if journal and journal.mood == val }}>
                        {{ label }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <input type="text" name="tags" value="{{ journal_tags }}" placeholder="Tags (comma-separated)" style="font-size: 12px; padding: 0.375rem 0.625rem;">
            </div>
        </div>
        <div class="btn-group">
            <button type="submit">Save</button>
        </div>
    </form>
</div>

<div class="secondary-grid">
    <div class="section-quiet">
        <h3>Tasks{% if tasks %} <span style="font-weight: 400; text-transform: none; letter-spacing: 0;">¬∑ {{ tasks | length }}</span>{% endif %}</h3>

        <form method="POST" action="/tasks/add">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="task-add-row">
                <input type="text" name="title" placeholder="Add a task..." required>
                <button type="submit">Add</button>
            </div>
        </form>

        {% if tasks %}
            <ul class="quiet-task-list">
                {% for task in tasks %}
                    <li class="{{ 'completed' if task.completed else '' }}">
                        <form method="POST" action="/tasks/{{ task.id }}/toggle" style="display: contents; margin: 0;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="checkbox"
                                   {{ 'checked' if task.completed else '' }}
                                   onchange="this.form.submit()">
                        </form>
                        <span style="flex: 1; min-width: 0;">
                            <a href="/tasks/{{ task.id }}/edit" class="task-link">{{ task.title }}</a>
                            {% if task.recurrence and task.recurrence != 'none' %}
                                <span class="recurrence-badge" title="Repeats {{ task.recurrence }}">&#x21bb;</span>
                            {% endif %}
                        </span>
                        {% if task.due_date %}
                            <span class="due-hint {{ 'overdue' if task.due_date < today else 'due-today' if task.due_date == today }}">{% if task.due_date == today %}today{% elif task.due_date < today %}overdue{% else %}{{ task.due_date | uk_date }}{% endif %}</span>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="quiet-empty">No tasks right now</div>
        {% endif %}

        {% if stats.completed_tasks > 0 %}
        <div class="tasks-footer">
            <a href="/completed-tasks">{{ stats.completed_tasks }} completed &rsaquo;</a>
        </div>
        {% endif %}
    </div>

    <div class="section-quiet">
        <h3>Blips</h3>

        {% if blips %}
            {% for blip in blips %}
                <div class="quiet-blip">
                    {{ blip.content }}
                    <div class="quiet-blip-meta">surfaced {{ blip.surface_count }}&times;</div>
                </div>
            {% endfor %}
        {% else %}
            <div class="quiet-empty">No blips yet. <a href="/blips">Add some</a></div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var textarea = document.getElementById('journal-content');
    var indicator = document.getElementById('save-indicator');
    var wordCount = document.getElementById('word-count');
    var timer = null;
    var lastSaved = textarea.value;

    function updateWordCount() {
        var text = textarea.value.trim();
        var count = text ? text.split(/\s+/).length : 0;
        wordCount.textContent = count + ' word' + (count !== 1 ? 's' : '');
    }

    function showIndicator(text, cls) {
        indicator.textContent = text;
        indicator.className = 'save-indicator visible' + (cls ? ' ' + cls : '');
        if (cls === 'saved') {
            setTimeout(function() { indicator.className = 'save-indicator'; }, 2000);
        }
    }

    function autoSave() {
        if (textarea.value === lastSaved) return;
        showIndicator('Saving...', '');
        var form = new FormData();
        form.append('content', textarea.value);
        form.append('csrf_token', document.querySelector('#journal-form input[name="csrf_token"]').value);
        fetch('/journal/save', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: form
        }).then(function(r) {
            if (r.ok) { lastSaved = textarea.value; showIndicator('Saved', 'saved'); }
        }).catch(function() {});
    }

    textarea.addEventListener('input', function() {
        updateWordCount();
        clearTimeout(timer);
        timer = setTimeout(autoSave, 1500);
    });
})();

function applyTemplate(content) {
    var textarea = document.getElementById('journal-content');
    textarea.value = content.replace(/\\n/g, '\n');
    textarea.focus();
    textarea.dispatchEvent(new Event('input'));
    var templateDiv = document.querySelector('.template-select');
    if (templateDiv) templateDiv.style.display = 'none';
}
</script>
{% endblock %}
