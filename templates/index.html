{% extends "base.html" %}

{% block title %}Today - Casey{% endblock %}

{% block extra_styles %}
.date-label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 1.5rem;
    letter-spacing: 0.01em;
}

.journal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.journal-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.word-count {
    font-size: 12px;
    color: var(--text-muted);
}

.task-input-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.task-input-row input[type="text"] {
    flex: 1;
}

.task-input-row input[type="date"] {
    width: auto;
    flex-shrink: 0;
    max-width: 140px;
}

.mood-selector {
    display: flex;
    gap: 0.25rem;
    align-items: center;
}

.mood-option {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 14px;
    border: 1px solid var(--border);
    background: var(--surface);
    transition: all 0.15s;
}

.mood-option:hover { border-color: var(--accent); }
.mood-option input { display: none; }
.mood-option.selected { border-color: var(--accent); background: var(--accent-subtle); }

.recurrence-badge {
    font-size: 10px;
    padding: 0.0625rem 0.3125rem;
    border-radius: 3px;
    background: var(--border-light);
    color: var(--text-muted);
    white-space: nowrap;
    margin-left: 0.25rem;
}

.task-input-row button {
    flex-shrink: 0;
}

.subtask-item {
    padding-left: 2rem !important;
}

.subtask-item input[type="checkbox"] {
    width: 16px !important;
    height: 16px !important;
    min-width: 16px !important;
    border-width: 1.5px !important;
}

.task-actions {
    display: flex;
    gap: 0.125rem;
    opacity: 0;
    transition: opacity 0.15s;
}

.task-item:hover .task-actions { opacity: 1; }

.subtask-toggle {
    font-size: 11px;
    padding: 0.125rem 0.375rem;
    min-height: auto;
    background: transparent;
    color: var(--text-muted);
    border: none;
    cursor: pointer;
}

.subtask-toggle:hover { color: var(--accent); background: transparent; }

.template-select {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
}

.template-btn {
    font-size: 11px;
    padding: 0.25rem 0.5rem;
    min-height: auto;
    background: var(--surface);
    color: var(--text-muted);
    border: 1px solid var(--border);
    cursor: pointer;
    border-radius: var(--radius-xs);
    font-family: var(--font);
    font-weight: 500;
    transition: all 0.15s;
}

.template-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-subtle);
}

.blip-label {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 500;
    margin-bottom: 0.75rem;
}

.blip-label svg {
    width: 14px;
    height: 14px;
    color: var(--accent);
}

.welcome {
    padding: 2rem;
    text-align: center;
    margin-bottom: 1.5rem;
}

.welcome h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    letter-spacing: -0.025em;
}

.welcome p {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.7;
    max-width: 480px;
    margin: 0 auto;
}

.welcome-features {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.welcome-feature {
    text-align: center;
    max-width: 160px;
}

.welcome-feature strong {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.welcome-feature span {
    font-size: 12px;
    color: var(--text-muted);
}
{% endblock %}

{% block content %}
<div class="date-label">{{ today | uk_date_long }}</div>

{% if not is_new_user and stats %}
<div class="stats-bar">
    <div class="stat-item"><span class="stat-value">{{ stats.entries }}</span> entries</div>
    <div class="stat-item"><span class="stat-value">{{ stats.active_tasks }}</span> active tasks</div>
    <div class="stat-item"><span class="stat-value">{{ stats.blips }}</span> blips</div>
    {% if stats.streak > 0 %}
    <div class="stat-item"><span class="stat-value accent">{{ stats.streak }}</span> day streak</div>
    {% endif %}
</div>
{% endif %}

{% if is_new_user %}
<div class="card welcome">
    <h2>Welcome to Casey</h2>
    <p>Your personal space for journaling, tracking tasks, and surfacing ideas. Start by writing in your journal, adding a task, or creating your first blip.</p>
    <div class="welcome-features">
        <div class="welcome-feature">
            <strong>Journal</strong>
            <span>Write freely each morning</span>
        </div>
        <div class="welcome-feature">
            <strong>Tasks</strong>
            <span>Track what needs doing</span>
        </div>
        <div class="welcome-feature">
            <strong>Blips</strong>
            <span>Ideas that resurface randomly</span>
        </div>
    </div>
</div>
{% endif %}

<div class="grid-2">
    <div>
        <div class="card">
            <div class="journal-header">
                <h2 style="margin-bottom: 0;">Journal</h2>
                <div class="journal-meta">
                    <span id="word-count" class="word-count">{{ (journal.content if journal else '') | word_count }} words</span>
                    <span id="save-indicator" class="save-indicator">Saved</span>
                </div>
            </div>
            <form id="journal-form" method="POST" action="/journal/save">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                {% if not journal or not journal.content %}
                <div class="template-select">
                    {% for tmpl in templates %}
                    {% if tmpl.content %}
                    <button type="button" class="template-btn" onclick="applyTemplate('{{ tmpl.content | e }}')">{{ tmpl.name }}</button>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                <textarea id="journal-content" name="content" rows="12" placeholder="What's on your mind today?">{{ journal.content if journal else '' }}</textarea>
                <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.75rem; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 12px; color: var(--text-muted); font-weight: 500;">Mood</span>
                        <div class="mood-selector">
                            {% for val, label in [(1, 'üòî'), (2, 'üòê'), (3, 'üôÇ'), (4, 'üòä'), (5, 'ü§©')] %}
                            <label class="mood-option {{ 'selected' if journal and journal.mood == val }}" title="{{ ['Rough','Meh','Okay','Good','Great'][val-1] }}" onclick="this.parentElement.querySelectorAll('.mood-option').forEach(e=>e.classList.remove('selected'));this.classList.add('selected')">
                                <input type="radio" name="mood" value="{{ val }}" {{ 'checked' if journal and journal.mood == val }}>
                                {{ label }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <input type="text" name="tags" value="{{ journal_tags }}" placeholder="Tags (comma-separated)" style="font-size: 12px; padding: 0.375rem 0.625rem;">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit">Save</button>
                </div>
            </form>
        </div>

        <div class="card">
            <h2>Blips</h2>
            <div class="blip-label">
                <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                    <path d="M8 3v10M4.5 7.5l3.5 3.5 3.5-3.5"/>
                </svg>
                Randomly surfaced for reflection
            </div>

            {% if blips %}
                {% for blip in blips %}
                    <div class="blip">
                        {{ blip.content }}
                        <div class="blip-meta">
                            Surfaced {{ blip.surface_count }}&times; &middot; {{ blip.created_at | uk_date }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state" style="padding: 1.5rem 1rem;">
                    No blips yet. <a href="/blips">Add some</a> to get started.
                </div>
            {% endif %}
        </div>
    </div>

    <div>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Tasks</h2>
                {% if stats.completed_tasks > 0 %}
                <a href="/completed-tasks" style="font-size: 12px; color: var(--text-muted); text-decoration: none; font-weight: 500;">{{ stats.completed_tasks }} completed &rsaquo;</a>
                {% endif %}
            </div>

            <form method="POST" action="/tasks/add">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="task-input-row">
                    <input type="text" name="title" placeholder="Add a task..." required>
                    <input type="date" name="due_date" title="Due date (optional)">
                    <select name="priority" title="Priority">
                        <option value="0">Normal</option>
                        <option value="1">Medium</option>
                        <option value="2">High</option>
                    </select>
                    <select name="recurrence" title="Repeat">
                        <option value="none">Once</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                    <button type="submit">Add</button>
                </div>
            </form>

            {% if tasks %}
                <ul class="task-list">
                    {% for task in tasks %}
                        <li class="task-item {{ 'completed' if task.completed else '' }}">
                            <form method="POST" action="/tasks/{{ task.id }}/toggle" style="display: flex; align-items: center; flex: 1; margin: 0;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="checkbox"
                                       {{ 'checked' if task.completed else '' }}
                                       onchange="this.form.submit()">
                                <span style="flex: 1; font-size: 14px;">
                                    <a href="/tasks/{{ task.id }}/edit" style="color: inherit; text-decoration: none;" title="Edit task">{{ task.title }}</a>
                                    {% if task.notes %}<span style="color: var(--text-muted); font-size: 11px; margin-left: 0.25rem;" title="{{ task.notes }}">&#128196;</span>{% endif %}
                                    {% if task.priority == 2 %}
                                        <span class="priority-badge high">High</span>
                                    {% elif task.priority == 1 %}
                                        <span class="priority-badge medium">Med</span>
                                    {% endif %}
                                    {% if task.recurrence and task.recurrence != 'none' %}
                                        <span class="recurrence-badge" title="Repeats {{ task.recurrence }}">&#x21bb; {{ task.recurrence[:1].upper() }}</span>
                                    {% endif %}
                                    {% if task.due_date %}
                                        <span class="due-badge {{ 'overdue' if task.due_date < today else 'due-today' if task.due_date == today }}">{% if task.due_date == today %}Today{% elif task.due_date < today %}Overdue{% else %}{{ task.due_date | uk_date }}{% endif %}</span>
                                    {% endif %}
                                </span>
                            </form>
                            <div class="task-actions">
                                <button type="button" class="subtask-toggle" title="Add subtask" onclick="toggleSubtaskInput({{ task.id }})">+sub</button>
                                <form method="POST" action="/tasks/{{ task.id }}/delete" style="margin: 0;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn-ghost btn-danger task-delete" title="Delete" style="padding: 0.25rem 0.375rem; font-size: 14px; line-height: 1; min-height: auto; opacity: 1;">&times;</button>
                                </form>
                            </div>
                        </li>
                        {% if task_subtasks.get(task.id) %}
                        {% for sub in task_subtasks[task.id] %}
                        <li class="task-item subtask-item {{ 'completed' if sub.completed else '' }}">
                            <form method="POST" action="/subtasks/{{ sub.id }}/toggle" style="display: flex; align-items: center; flex: 1; margin: 0;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="checkbox" {{ 'checked' if sub.completed else '' }} onchange="this.form.submit()">
                                <span style="flex: 1; font-size: 13px;">{{ sub.title }}</span>
                            </form>
                            <form method="POST" action="/subtasks/{{ sub.id }}/delete" style="margin: 0;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn-ghost btn-danger task-delete" title="Delete subtask" style="padding: 0.125rem 0.25rem; font-size: 12px; line-height: 1; min-height: auto;">&times;</button>
                            </form>
                        </li>
                        {% endfor %}
                        {% endif %}
                        <li class="subtask-add" style="display: none;" data-task="{{ task.id }}">
                            <form method="POST" action="/tasks/{{ task.id }}/subtasks/add" style="display: flex; align-items: center; gap: 0.375rem; margin: 0; padding: 0.375rem 0 0.375rem 2rem;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="text" name="title" placeholder="Add subtask..." required style="font-size: 12px; padding: 0.25rem 0.5rem; flex: 1;">
                                <button type="submit" style="font-size: 11px; padding: 0.25rem 0.5rem; min-height: auto;">Add</button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="empty-state" style="padding: 1.5rem 1rem;">
                    No active tasks
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var textarea = document.getElementById('journal-content');
    var indicator = document.getElementById('save-indicator');
    var wordCount = document.getElementById('word-count');
    var timer = null;
    var lastSaved = textarea.value;

    function updateWordCount() {
        var text = textarea.value.trim();
        var count = text ? text.split(/\s+/).length : 0;
        wordCount.textContent = count + ' word' + (count !== 1 ? 's' : '');
    }

    function showIndicator(text, cls) {
        indicator.textContent = text;
        indicator.className = 'save-indicator visible' + (cls ? ' ' + cls : '');
        if (cls === 'saved') {
            setTimeout(function() { indicator.className = 'save-indicator'; }, 2000);
        }
    }

    function autoSave() {
        if (textarea.value === lastSaved) return;
        showIndicator('Saving...', '');
        var form = new FormData();
        form.append('content', textarea.value);
        form.append('csrf_token', document.querySelector('#journal-form input[name="csrf_token"]').value);
        fetch('/journal/save', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: form
        }).then(function(r) {
            if (r.ok) { lastSaved = textarea.value; showIndicator('Saved', 'saved'); }
        }).catch(function() {});
    }

    textarea.addEventListener('input', function() {
        updateWordCount();
        clearTimeout(timer);
        timer = setTimeout(autoSave, 1500);
    });
})();

function toggleSubtaskInput(taskId) {
    var el = document.querySelector('.subtask-add[data-task="' + taskId + '"]');
    if (el) {
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
        if (el.style.display === 'block') {
            el.querySelector('input[name="title"]').focus();
        }
    }
}

function applyTemplate(content) {
    var textarea = document.getElementById('journal-content');
    textarea.value = content.replace(/\\n/g, '\n');
    textarea.focus();
    textarea.dispatchEvent(new Event('input'));
    // Hide template buttons
    var templateDiv = document.querySelector('.template-select');
    if (templateDiv) templateDiv.style.display = 'none';
}
</script>
{% endblock %}
